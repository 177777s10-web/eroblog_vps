import os
import sys
import json
import re
import django
from pathlib import Path
from datetime import datetime
from django.utils import timezone

# --- Djangoç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— ---
SCRIPT_DIR = Path(__file__).resolve().parent
PROJECT_ROOT = SCRIPT_DIR.parent
sys.path.append(str(PROJECT_ROOT.parent)) # eroblog/
sys.path.append(str(PROJECT_ROOT)) # blog_builder/

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'blog_builder.settings')
django.setup()

# --- Djangoã®éƒ¨å“ï¼ˆãƒ¢ãƒ‡ãƒ«ï¼‰ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ ---
from posts.models import Post

# --- ãƒ‘ã‚¹å®šç¾© ---
CONTENT_ROOT = PROJECT_ROOT.parent / "content"
QUEUE_DIR = PROJECT_ROOT.parent / "publish_queue"
DRAFTS_DIR = CONTENT_ROOT / "drafts" # ğŸ‘ˆ drafts
PUBLISHED_DIR = CONTENT_ROOT / "published" # ğŸ‘ˆ published
PUBLISHED_DIR.mkdir(parents=True, exist_ok=True)

# --- .md åŸç¨¿ã‚’ãƒ‘ãƒ¼ã‚¹ï¼ˆè§£æï¼‰ã™ã‚‹é–¢æ•° ---
def parse_markdown_file(md_path):
    print(f"  Parsing Markdown: {md_path.name}")
    content = md_path.read_text(encoding="utf-8")
    
    frontmatter_match = re.match(r'^---\s*$(.*)^---\s*$(.*)', content, re.DOTALL | re.MULTILINE)
    if not frontmatter_match:
        raise ValueError(f"  â”” ERROR: ãƒ•ãƒ­ãƒ³ãƒˆãƒã‚¿ãƒ¼(---)ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚")
        
    frontmatter_raw = frontmatter_match.group(1)
    body_raw = frontmatter_match.group(2)
    
    review_match = re.search(r'^##\s+ç´¹ä»‹æ–‡ï¼ˆãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰\s*$(.*)', body_raw, re.DOTALL | re.MULTILINE)
    review_body = ""
    if review_match:
        review_body = review_match.group(1).split('## ')[0].strip()
        
    data = {'review_body': review_body}
    
    # 1. ãƒ•ãƒ­ãƒ³ãƒˆãƒã‚¿ãƒ¼ (---) ã‹ã‚‰æŠ½å‡º
    for line in frontmatter_raw.splitlines():
        if ":" in line:
            key_raw, val = line.split(":", 1)
            key = re.sub(r'[\*\s]', '', key_raw)
            val = val.strip().strip('"').strip("'")
            if key == 'tags':
                data[key] = [t.strip().strip("-").strip() for t in val.split("\n") if t.strip() and t.strip().startswith('-')]
            else:
                data[key] = val
                
    # 2. æœ¬æ–‡ã®ã€ŒåŸºæœ¬æƒ…å ±ã€ãƒªã‚¹ãƒˆ (* **...**) ã‹ã‚‰æŠ½å‡º
    info_match = re.search(r'^##\s+ä½œå“ã®åŸºæœ¬æƒ…å ±\s*$(.*?)(\n##|$)', body_raw, re.DOTALL | re.MULTILINE)
    if info_match:
        info_block = info_match.group(1)
        for line in info_block.splitlines():
            if ":" in line:
                key_raw, val = line.split(":", 1)
                key = re.sub(r'[\*\s]', '', key_raw)
                val = val.strip().strip('`')
                
                if key == 'å‡ºæ¼”è€…': data['name'] = val
                elif key == 'ãƒ¡ãƒ¼ã‚«ãƒ¼': data['maker'] = val
                elif key == 'ãƒ¬ãƒ¼ãƒ™ãƒ«': data['label'] = val
                elif key == 'ã‚µã‚¤ã‚º': data['sizes'] = val
                elif key == 'ã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ãƒˆURL': data['affiliate_url'] = val
                elif key == 'ã‚µãƒ³ãƒ—ãƒ«å‹•ç”»': data['sample_movie_url'] = val

    return data

# --- [æ–°è¨­] åŸç¨¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¢ã™é–¢æ•° ---
def find_md_file(draft_path_str):
    """ drafts/ ã¨ published/ ã®ä¸¡æ–¹ã‹ã‚‰åŸç¨¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¢ã™ """
    
    # 1. ã‚­ãƒ¥ãƒ¼ã«æ›¸ã‹ã‚ŒãŸãƒ‘ã‚¹ï¼ˆdrafts/ï¼‰ã‚’æ¢ã™
    md_path1 = PROJECT_ROOT.parent / draft_path_str
    if md_path1.exists():
        return md_path1 # drafts/ ã«ã‚ã£ãŸ
        
    # 2. published/ ã®ä¸­ã‚‚æ¢ã™
    file_name = Path(draft_path_str).name
    md_path2 = PUBLISHED_DIR / file_name
    if md_path2.exists():
        return md_path2 # published/ ã«ã‚ã£ãŸ
        
    # ã©ã£ã¡ã«ã‚‚ãªã„
    raise FileNotFoundError(f"  â”” ERROR: åŸç¨¿ãƒ•ã‚¡ã‚¤ãƒ« {md_path1.name} ãŒ drafts/ ã«ã‚‚ published/ ã«ã‚‚è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚")

# --- ãƒ¡ã‚¤ãƒ³ã®å®Ÿè¡Œãƒ­ã‚¸ãƒƒã‚¯ ---
def main():
    print(f"--- è‡ªå‹•ç™»éŒ²ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’é–‹å§‹ã—ã¾ã™ ---")
    print(f"å…¬é–‹ã‚­ãƒ¥ãƒ¼ã‚’ç›£è¦–ä¸­: {QUEUE_DIR}")
    
    json_files = list(QUEUE_DIR.glob("*.json"))
    if not json_files:
        print("ã‚­ãƒ¥ãƒ¼ã«ç™»éŒ²ã•ã‚ŒãŸè¨˜äº‹ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚")
        return

    for json_file in json_files:
        print(f"[PROCESS] '{json_file.name}' ã‚’å‡¦ç†ä¸­...")
        try:
            q_data = json.loads(json_file.read_text(encoding="utf-8"))
            cid = q_data.get("cid")
            draft_path_str = q_data.get("draft_path")
            
            if not cid or not draft_path_str:
                raise ValueError("  â”” ERROR: json ã« cid ã¾ãŸã¯ draft_path ãŒã‚ã‚Šã¾ã›ã‚“ã€‚")

            if Post.objects.filter(cid=cid).exists():
                print(f"  â”” INFO: {cid} ã¯æ—¢ã«DBã«å­˜åœ¨ã™ã‚‹ãŸã‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚")
                json_file.unlink()
                continue
                
            # [ä¿®æ­£] è³¢ã„ãƒ•ã‚¡ã‚¤ãƒ«æ¤œç´¢ã‚’ä½¿ã†
            md_path = find_md_file(draft_path_str)
                
            md_data = parse_markdown_file(md_path)
            
            new_md_path_obj = PUBLISHED_DIR / md_path.name
            new_draft_path_str = str(new_md_path_obj.relative_to(PROJECT_ROOT.parent))

            release_dt = None
            date_str = md_data.get('date', None)
            if date_str:
                try:
                    naive_dt = datetime.strptime(date_str, '%Y-%m-%d')
                    release_dt = timezone.make_aware(naive_dt, timezone.get_default_timezone())
                except ValueError:
                    release_dt = timezone.now()

            new_post = Post(
                cid = cid,
                title = md_data.get('title', ''),
                name = md_data.get('name', ''),
                maker = md_data.get('maker', ''),
                label = md_data.get('label', ''),
                sizes = md_data.get('sizes', ''),
                genres = md_data.get('tags', []), 
                review_body = md_data.get('review_body', ''),
                affiliate_url = md_data.get('affiliate_url', ''),
                sample_movie_url = md_data.get('sample_movie_url', ''),
                draft_path = new_draft_path_str,
                poster_image_file = md_data.get('poster_image', '').replace('../', 'content/'),
                sample_image_files = [f"content/assets/{cid}_{i:02d}.jpg" for i in range(1, 6)],
                release_date = release_dt
            )
            
            new_post.save()
            print(f"  ğŸ‰ SUCCESS: [{cid}] {new_post.title} ã‚’DBã«ä¿å­˜ã—ã¾ã—ãŸã€‚")
            
            # [ä¿®æ­£] ã‚‚ã—ãƒ•ã‚¡ã‚¤ãƒ«ãŒ drafts/ ã«ã‚ã£ãŸå ´åˆã ã‘ã€published/ ã«ç§»å‹•ã™ã‚‹
            if md_path.parent.name == DRAFTS_DIR.name:
                md_path.rename(new_md_path_obj)
                print(f"  â”” åŸç¨¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ {PUBLISHED_DIR.name} ã«ç§»å‹•ã—ã¾ã—ãŸã€‚")
            
            json_file.unlink()

        except Exception as e:
            print(f"  ğŸ”¥ FAILED: {json_file.name} ã®å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚")
            print(e)

    print(f"--- è‡ªå‹•ç™»éŒ²ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’çµ‚äº†ã—ã¾ã™ ---")

if __name__ == "__main__":
    main()
