    draft_rel = data.get("draft_path")
    if not cid or not draft_rel:
        print(f"[FAIL] queue不備: {queue_json.name}")
        return

    md_path = (EROBLOG / draft_rel).resolve()
    if not md_path.exists():
        print(f"[FAIL] 原稿なし: {md_path}")
        return

    fm, body_md = parse_front_matter_and_body(md_path)
    title = fm.get("title") or data.get("title") or "無題"
    date_s = fm.get("date") or data.get("date")
    date_v = coerce_date(date_s)

    review_text = extract_review_from_markdown(body_md)

    Post = getattr(post_models, "Post")
    with transaction.atomic():
        obj, _ = Post.objects.get_or_create(cid=cid)
        set_if_exists(obj, "cid", cid)
        set_if_exists(obj, "title", title)

        if hasattr(obj, "review_body"):
            obj.review_body = review_text

        set_if_exists(obj, "slug", slugify(f"{cid}-{title}")[:80])
        set_if_exists(obj, "affiliate_url", fm.get("affiliate_url"))
        set_if_exists(obj, "sample_movie_url", fm.get("sample_movie"))
        set_if_exists(obj, "name", fm.get("name"))
        set_if_exists(obj, "maker", fm.get("maker"))
        set_if_exists(obj, "label", fm.get("label"))
        set_if_exists(obj, "sizes", fm.get("sizes"))
        set_if_exists(obj, "poster_image_file", fm.get("poster_image"))
        set_if_exists(obj, "draft_path", str(md_path.relative_to(EROBLOG)))
        if date_v and hasattr(obj, "date"):
            obj.date = date_v
        obj.save()

    dest = PUBLISHED_DIR / md_path.name
    try:
        shutil.move(str(md_path), str(dest))
    except Exception:
        shutil.copy2(str(md_path), str(dest))
        md_path.unlink(missing_ok=True)
    queue_json.unlink(missing_ok=True)

    print(f"[OK] import: cid={cid} title={title} review_len={len(review_text)} -> published/{dest.name}")

def main():
    if not QUEUE_DIR.exists():
        print("[INFO] publish_queue がありません。処理なし。")
        return
    items = sorted(QUEUE_DIR.glob("*.json"))
    if not items:
        print("[INFO] publish_queue に未処理キューがありません。")
        return
    for q in items:
        try:
            import_one(q)
        except Exception as e:
            print(f"[ERROR] {q.name}: {e}")

if __name__ == "__main__":
    main()
